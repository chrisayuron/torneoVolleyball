<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Torneo de Voleibol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            transition: background-color 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:disabled {
            background-color: #94a3b8; /* slate-400 */
            cursor: not-allowed;
        }
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .btn-primary {
            background-color: #1d4ed8; /* blue-700 */
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #1e40af; /* blue-800 */
        }
        .btn-secondary {
            background-color: #334155; /* slate-700 */
        }
        .btn-secondary:hover {
            background-color: #1e293b; /* slate-800 */
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }
        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #2563eb; /* blue-600 */
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
        }
        .input-field:read-only, .input-field:disabled {
            background-color: #f1f5f9; /* slate-100 */
            cursor: not-allowed;
        }
        .table-header {
            background-color: #f1f5f9; /* slate-100 */
            font-weight: 600;
        }
        .winner-banner {
            background: linear-gradient(45deg, #fbbf24, #f59e0b, #ea580c);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            border: 4px solid #fcd34d;
        }
        #modal, #loading-screen {
            transition: opacity 0.3s ease;
        }
        .spinner {
            border: 4px solid #e2e8f0; /* slate-200 */
            border-top: 4px solid #2563eb; /* blue-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-4 sm:p-6 md:p-8">

    <div id="loading-screen" class="fixed inset-0 bg-slate-100 flex flex-col items-center justify-center z-50 p-4">
        <div class="spinner"></div>
        <p class="text-slate-600 mt-4">Cargando configuraci√≥n...</p>
    </div>

    <div id="login-screen" class="fixed inset-0 bg-slate-100 flex items-center justify-center z-50 p-4 hidden">
        <div class="w-full max-w-sm">
            <div class="card text-center">
                <h2 id="login-title" class="text-2xl font-bold mb-4">Acceso Protegido</h2>
                <p id="login-subtitle" class="text-slate-600 mb-6">Por favor, introduce la clave maestra para continuar.</p>
                <div class="relative mb-4">
                    <input type="password" id="password-input" class="input-field pr-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <button id="toggle-password-btn" onclick="app.togglePasswordVisibility()" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 focus:outline-none">
                        <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg id="eye-slash-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057-5.064 7-9.542 7 .847 0 1.67 .111 2.457 .311M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2 2l20 20" />
                        </svg>
                    </button>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 h-5"></p>
                <button id="login-btn" class="btn btn-primary w-full">Continuar</button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-800 flex items-center justify-center">
                <span class="text-red-600">üèê</span> 
                <span class="mx-4">Organizador de Torneo de Voleibol</span>
                <span class="text-red-600">üèê</span>
            </h1>
            <p class="text-lg text-slate-600 mt-2">Gestiona los equipos, partidos y clasificaciones de tu torneo interclases.</p>
        </header>

        <div id="winner-section" class="hidden card winner-banner">
            <h2 class="text-3xl font-bold mb-2">¬°TENEMOS UN CAMPE√ìN!</h2>
            <p id="winner-name" class="text-5xl font-extrabold"></p>
            <button onclick="app.resetTournament()" class="btn btn-secondary mt-6">Iniciar Nuevo Torneo</button>
        </div>

        <div id="main-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg-col-span-1">
                    <div id="config-panel">
                        <div class="card">
                            <h2 class="text-2xl font-bold mb-4 flex items-center text-blue-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                1. Registrar Equipos
                            </h2>
                            <div id="add-team-wrapper" class="flex gap-2">
                                <input type="text" id="team-name" class="input-field" placeholder="Nombre del curso (Ej: 11-A)">
                                <button id="add-team-btn" onclick="app.addTeam()" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                    A√±adir
                                </button>
                            </div>
                            <div id="teams-list" class="mt-4 space-y-2"></div>
                            <button id="clear-teams-btn" onclick="app.clearTeams()" class="btn btn-danger w-full mt-4 hidden">
                                Limpiar Equipos
                            </button>
                        </div>

                        <div class="card">
                             <h2 class="text-2xl font-bold mb-4 flex items-center text-blue-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                2. Generar Partidos
                            </h2>
                            <p class="text-slate-600 mb-4">Una vez a√±adidos todos los equipos, genera el calendario de partidos.</p>
                            <button id="generate-schedule-btn" onclick="app.generateSchedule()" class="btn btn-secondary w-full" disabled>Generar Calendario</button>
                            <button id="reset-tournament-btn" onclick="app.resetTournament()" class="btn btn-danger w-full mt-4 hidden">
                                Reiniciar Torneo Completo
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div id="no-data-notification" class="card text-center bg-blue-50 border-blue-200 hidden">
                        <h3 class="text-xl font-semibold text-blue-800">¬°Bienvenido!</h3>
                        <p class="text-blue-600 mt-2">Parece que no hay un torneo en curso. Para empezar, a√±ade tu primer equipo en el panel de la izquierda.</p>
                    </div>

                    <div id="schedule-section" class="card hidden">
                        <h2 class="text-2xl font-bold mb-4 flex items-center text-blue-800">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                            Calendario de Partidos
                        </h2>
                        <div id="schedule-list" class="space-y-6"></div>
                    </div>

                    <div id="standings-section" class="card hidden">
                        <h2 class="text-2xl font-bold mb-4 flex items-center text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            Tabla de Posiciones
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left">
                                <thead class="table-header">
                                    <tr>
                                        <th class="p-2">Pos</th>
                                        <th class="p-2">Equipo</th>
                                        <th class="p-2 text-center" title="Partidos Jugados">PJ</th>
                                        <th class="p-2 text-center" title="Partidos Ganados">G</th>
                                        <th class="p-2 text-center" title="Partidos Perdidos">P</th>
                                        <th class="p-2 text-center" title="Sets a Favor">SF</th>
                                        <th class="p-2 text-center" title="Sets en Contra">SC</th>
                                        <th class="p-2 text-center" title="Diferencia de Sets">DS</th>
                                        <th class="p-2 text-center" title="Puntos a Favor">PF</th>
                                        <th class="p-2 text-center" title="Puntos en Contra">PC</th>
                                        <th class="p-2 text-center" title="Diferencia de Puntos">DP</th>
                                        <th class="p-2 text-center" title="Puntos Totales">Pts</th>
                                    </tr>
                                </thead>
                                <tbody id="standings-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                                        
                     <div id="final-match-section" class="card hidden">
                        <h2 class="text-2xl font-bold mb-4 text-center text-yellow-500">üî• ¬°LA GRAN FINAL! üî•</h2>
                         <div id="final-match-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                <div id="modal-message"></div>
                <div id="modal-buttons" class="flex justify-center gap-4 mt-6">
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const App = function() {
            this.teams = [];
            this.schedule = [];
            this.finalMatch = null;
            this.isAuthenticated = false;
            this.initialLoadComplete = false;
            
            this.db = null;
            this.auth = null;
            this.userId = null;
            this.appId = 'default-app-id-volleyball';
            this.unsubscribe = null;

            this.showAlert = function(message) {
                const modal = document.getElementById('modal');
                document.getElementById('modal-message').innerHTML = `<p class="text-lg">${message}</p>`;
                document.getElementById('modal-buttons').innerHTML = `<button onclick="app.hideModal()" class="btn btn-primary">Entendido</button>`;
                modal.classList.remove('hidden');
            }

            this.showConfirm = function(message, onConfirm) {
                const modal = document.getElementById('modal');
                document.getElementById('modal-message').innerHTML = `<p class="text-lg">${message}</p>`;
                document.getElementById('modal-buttons').innerHTML = `
                    <button onclick="app.hideModal()" class="btn btn-secondary">Cancelar</button>
                    <button id="confirm-btn" class="btn btn-danger">Confirmar</button>
                `;
                modal.classList.remove('hidden');
                document.getElementById('confirm-btn').onclick = () => {
                    this.hideModal();
                    onConfirm();
                };
            }

            this.hideModal = function() {
                document.getElementById('modal').classList.add('hidden');
            }
            
            this.init = async function() {
                try {
                    const response = await fetch('/api/get-config');
                    if (!response.ok) throw new Error('No se pudo obtener la configuraci√≥n del servidor.');
                    const firebaseConfig = await response.json();

                    const firebaseApp = initializeApp(firebaseConfig);
                    this.db = getFirestore(firebaseApp);
                    this.auth = getAuth(firebaseApp);
                    this.appId = firebaseConfig.appId;

                    onAuthStateChanged(this.auth, async (user) => {
                        if (user) {
                            this.userId = user.uid;
                            if (!this.initialLoadComplete) {
                                this.initialLoadComplete = true;
                                document.getElementById('loading-screen').classList.add('hidden');
                                document.getElementById('login-screen').classList.remove('hidden');
                                this.checkAuth();
                            }
                            this.setupFirestoreListener();
                        } else {
                           await signInAnonymously(this.auth);
                        }
                    });
                } catch (error) {
                    console.error("Error cr√≠tico de inicializaci√≥n:", error);
                    document.getElementById('loading-screen').classList.add('hidden');
                    this.showAlert(`Error al cargar la aplicaci√≥n: ${error.message}`);
                }
            }
            
            this.setupFirestoreListener = function() {
                if (this.unsubscribe) this.unsubscribe(); 
                
                const mainStateRef = doc(this.db, "tournaments", this.appId, "data", "mainState");
                this.unsubscribe = onSnapshot(mainStateRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const state = docSnap.data();
                        this.teams = state.teams || [];
                        this.schedule = state.schedule || [];
                        this.finalMatch = state.finalMatch || null;
                        document.getElementById('no-data-notification').classList.add('hidden');
                    } else {
                        this.teams = [];
                        this.schedule = [];
                        this.finalMatch = null;
                        document.getElementById('no-data-notification').classList.remove('hidden');
                    }
                    if(this.isAuthenticated) this.renderAll();
                }, (error) => {
                    console.error("Error escuchando cambios en Firestore: ", error);
                    this.showAlert("No se pudo conectar a la base de datos.");
                });
            }
            
            this.saveStateToFirestore = async function() {
                if (!this.userId) return;
                try {
                    const mainStateRef = doc(this.db, "tournaments", this.appId, "data", "mainState");
                    await setDoc(mainStateRef, {
                        teams: JSON.parse(JSON.stringify(this.teams)), 
                        schedule: JSON.parse(JSON.stringify(this.schedule)),
                        finalMatch: JSON.parse(JSON.stringify(this.finalMatch)),
                    });
                } catch (error) {
                    console.error("Error guardando en Firestore: ", error);
                    this.showAlert("Hubo un error al guardar los datos.");
                }
            }

            this.checkAuth = function() {
                const loginBtn = document.getElementById('login-btn');
                const passwordInput = document.getElementById('password-input');
                passwordInput.focus();
                loginBtn.onclick = () => this.verifyPassword();
                passwordInput.onkeyup = (e) => { if (e.key === 'Enter') this.verifyPassword(); };
            }

            this.verifyPassword = async function() {
                const passwordInput = document.getElementById('password-input');
                const loginError = document.getElementById('login-error');
                const loginBtn = document.getElementById('login-btn');
                loginBtn.disabled = true;

                try {
                    const configRef = doc(this.db, "tournaments", this.appId, "config", "master");
                    const configSnap = await getDoc(configRef);

                    if (configSnap.exists() && configSnap.data().masterPassword) {
                        const masterPassword = configSnap.data().masterPassword;
                        if (passwordInput.value === masterPassword) {
                            this.isAuthenticated = true;
                            document.getElementById('login-screen').classList.add('hidden');
                            document.getElementById('app').classList.remove('hidden');
                            this.renderAll();
                        } else {
                            loginError.textContent = 'Clave incorrecta.';
                        }
                    } else {
                         this.showAlert("Error: La contrase√±a maestra no est√° configurada en la base de datos.");
                    }
                } catch (error) {
                    console.error("Error verifying password:", error);
                    loginError.textContent = 'Error al verificar.';
                } finally {
                    loginBtn.disabled = false;
                }
            }

            this.togglePasswordVisibility = function() {
                const passwordInput = document.getElementById('password-input');
                const eyeIcon = document.getElementById('eye-icon');
                const eyeSlashIcon = document.getElementById('eye-slash-icon');

                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeSlashIcon.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeSlashIcon.classList.add('hidden');
                }
            }
            
            this.addTeam = function() {
                if (this.schedule.length > 0) return;
                const teamNameInput = document.getElementById('team-name');
                const name = teamNameInput.value.trim();
                if (name && !this.teams.some(team => team.name === name)) {
                    this.teams.push({ name, pj: 0, g: 0, p: 0, sf: 0, sc: 0, ds: 0, pf: 0, pc: 0, dp: 0, pts: 0 });
                    teamNameInput.value = '';
                    this.saveStateToFirestore();
                }
            }
            
            this.removeTeam = function(index) {
                if (this.schedule.length > 0) return;
                this.teams.splice(index, 1);
                this.saveStateToFirestore();
            }
            
            this.clearTeams = function() {
                 this.showConfirm("¬øEst√°s seguro de que deseas eliminar todos los equipos?", () => {
                    this.teams = [];
                    this.saveStateToFirestore();
                 });
            }
            
            this.generateSchedule = function() {
                if (this.teams.length < 2) {
                    this.showAlert("Necesitas al menos 2 equipos para generar un calendario.");
                    return;
                }

                // 1. Generate all possible matches using a round-robin algorithm.
                let teams = [...this.teams.map(t => t.name)];
                const groupedSchedule = [];

                if (teams.length % 2 !== 0) {
                    teams.push("descanso");
                }

                const numTeams = teams.length;
                const numRounds = numTeams - 1;

                for (let round = 0; round < numRounds; round++) {
                    const roundMatches = [];
                    for (let i = 0; i < numTeams / 2; i++) {
                        const team1 = teams[i];
                        const team2 = teams[numTeams - 1 - i];

                        if (team1 !== "descanso" && team2 !== "descanso") {
                             const matchData = (round % 2 === 1) 
                                ? { team1: team1, team2: team2 } 
                                : { team1: team2, team2: team1 };
                            roundMatches.push({
                                ...matchData,
                                sets: [{ s1: null, s2: null }, { s1: null, s2: null }, { s1: null, s2: null }],
                                setsWon1: 0,
                                setsWon2: 0,
                                played: false,
                                winner: null,
                                mvp: ''
                            });
                        }
                    }
                    groupedSchedule.push(roundMatches);
                    
                    const lastTeam = teams.pop();
                    teams.splice(1, 0, lastTeam);
                }

                let allMatches = groupedSchedule.flat();

                // 2. Extract the match between the first two registered teams.
                const team1Name = this.teams[0].name;
                const team2Name = this.teams[1].name;
                let firstMatch = null;

                const firstMatchIndex = allMatches.findIndex(m =>
                    (m.team1 === team1Name && m.team2 === team2Name) ||
                    (m.team1 === team2Name && m.team2 === team1Name)
                );
                if (firstMatchIndex !== -1) {
                    firstMatch = allMatches.splice(firstMatchIndex, 1)[0];
                }

                // 3. Create a fair, sequential schedule to avoid back-to-back games.
                const finalSchedule = [];
                if (firstMatch) {
                    finalSchedule.push(firstMatch);
                }

                let lastTeams = firstMatch ? [firstMatch.team1, firstMatch.team2] : [];

                while (allMatches.length > 0) {
                    let foundNextMatch = false;
                    for (let i = 0; i < allMatches.length; i++) {
                        const potentialMatch = allMatches[i];
                        if (!lastTeams.includes(potentialMatch.team1) && !lastTeams.includes(potentialMatch.team2)) {
                            const nextMatch = allMatches.splice(i, 1)[0];
                            finalSchedule.push(nextMatch);
                            lastTeams = [nextMatch.team1, nextMatch.team2];
                            foundNextMatch = true;
                            break;
                        }
                    }
                    
                    if (!foundNextMatch && allMatches.length > 0) {
                        const nextMatch = allMatches.shift();
                        finalSchedule.push(nextMatch);
                        lastTeams = [nextMatch.team1, nextMatch.team2];
                    }
                }

                // 4. Assign final jornada numbers and save.
                this.schedule = finalSchedule.map((match, index) => ({
                    ...match,
                    round: index + 1
                }));

                this.saveStateToFirestore();
            }
            
            this.isSetWinner = function(score1, score2) {
                if (score1 >= 10 && score1 >= score2 + 2) return true;
                if (score2 >= 10 && score2 >= score1 + 2) return true;
                return false;
            }

            this.updateLiveScoreDisplay = function(index, isFinal = false) {
                const idPrefix = isFinal ? 'final' : index;
                const mainScoreDisplay = document.getElementById(`main-score-${idPrefix}`);
                const set3Wrapper = document.getElementById(`set3-wrapper-${idPrefix}`);

                let setsWon1 = 0;
                let setsWon2 = 0;

                for (let i = 0; i < 2; i++) {
                    const s1Input = document.getElementById(`set${i+1}-s1-${idPrefix}`);
                    const s2Input = document.getElementById(`set${i+1}-s2-${idPrefix}`);
                    if (s1Input && s2Input) {
                        const s1 = parseInt(s1Input.value) || 0;
                        const s2 = parseInt(s2Input.value) || 0;
                        if (this.isSetWinner(s1, s2)) {
                            if (s1 > s2) setsWon1++;
                            else setsWon2++;
                        }
                    }
                }

                if (mainScoreDisplay) mainScoreDisplay.textContent = `${setsWon1} - ${setsWon2}`;
                if (set3Wrapper) {
                    if (setsWon1 === 1 && setsWon2 === 1) {
                        set3Wrapper.classList.remove('hidden');
                    } else {
                        set3Wrapper.classList.add('hidden');
                    }
                }
            }


            this.updateMatchScores = function(index, isFinal = false) {
                const match = isFinal ? this.finalMatch : this.schedule[index];
                const idPrefix = isFinal ? 'final' : index;

                for (let i = 0; i < 3; i++) {
                    const s1Input = document.getElementById(`set${i+1}-s1-${idPrefix}`);
                    const s2Input = document.getElementById(`set${i+1}-s2-${idPrefix}`);
                    if (s1Input && s2Input) {
                        const s1 = s1Input.value === '' ? null : parseInt(s1Input.value);
                        const s2 = s2Input.value === '' ? null : parseInt(s2Input.value);
                        
                        if ((s1 === null && s2 !== null) || (s1 !== null && s2 === null) || s1 < 0 || s2 < 0) {
                            this.showAlert(`Por favor, introduce un marcador v√°lido para el Set ${i+1}. Ambos campos deben estar llenos con n√∫meros no negativos.`);
                            return;
                        }

                        if(s1 !== null && s1 === s2 && s1 >= 9){
                            this.showAlert(`El Set ${i+1} est√° empatado. Un equipo debe ganar por una diferencia de 2 puntos.`);
                            return;
                        }

                        match.sets[i] = { s1, s2 };
                    }
                }
                
                let setsWon1 = 0;
                let setsWon2 = 0;
                for (const set of match.sets) {
                    if (set.s1 !== null && set.s2 !== null) {
                        if(this.isSetWinner(set.s1, set.s2)){
                           if (set.s1 > set.s2) setsWon1++;
                           else if (set.s2 > set.s1) setsWon2++;
                        }
                    }
                }
                match.setsWon1 = setsWon1;
                match.setsWon2 = setsWon2;

                if (setsWon1 >= 2 || setsWon2 >= 2) {
                    match.played = true;
                    if(setsWon1 > setsWon2) match.winner = match.team1;
                    else match.winner = match.team2;

                    const mvpInput = document.getElementById(`mvp-${idPrefix}`);
                    if(mvpInput) match.mvp = mvpInput.value.trim();
                } else {
                    match.played = false;
                    match.winner = null;
                }

                this.saveStateToFirestore();
            }
            
            this.calculateTeamStats = function() {
                if (!Array.isArray(this.teams) || !Array.isArray(this.schedule)) return;
                
                this.teams.forEach(team => {
                    team.pj = 0; team.g = 0; team.p = 0;
                    team.sf = 0; team.sc = 0;
                    team.pf = 0; team.pc = 0; 
                    team.pts = 0;
                });

                this.schedule.forEach(match => {
                    if (match && match.played) {
                        const t1 = this.teams.find(t => t.name === match.team1);
                        const t2 = this.teams.find(t => t.name === match.team2);
                        if (!t1 || !t2) return;

                        t1.pj++; t2.pj++;
                        t1.sf += match.setsWon1 || 0;
                        t1.sc += match.setsWon2 || 0;
                        t2.sf += match.setsWon2 || 0;
                        t2.sc += match.setsWon1 || 0;

                        if (Array.isArray(match.sets)) {
                            match.sets.forEach(set => {
                                if (set && set.s1 !== null && set.s2 !== null) {
                                    t1.pf += set.s1; t1.pc += set.s2;
                                    t2.pf += set.s2; t2.pc += set.s1;
                                }
                            });
                        }

                        if (match.winner === t1.name) {
                            t1.g++; t2.p++;
                            if (match.setsWon1 === 2 && match.setsWon2 === 0) t1.pts += 3;
                            else t1.pts += 2;
                            t2.pts += (match.setsWon2 === 1) ? 1 : 0;
                        } else if (match.winner === t2.name) {
                            t2.g++; t1.p++;
                            if (match.setsWon2 === 2 && match.setsWon1 === 0) t2.pts += 3;
                            else t2.pts += 2;
                            t1.pts += (match.setsWon1 === 1) ? 1 : 0;
                        }
                    }
                });
                
                 this.teams.forEach(team => {
                    team.ds = team.sf - team.sc;
                    team.dp = team.pf - team.pc;
                });

                this.teams.sort((a, b) => b.pts - a.pts || b.ds - a.ds || b.dp - a.dp || a.name.localeCompare(b.name));
            }
            
            this.checkIfTournamentFinished = function() {
                const allPlayed = this.schedule.length > 0 && this.schedule.every(m => m.played);
                if(allPlayed && !this.finalMatch && this.teams.length >= 2) {
                   this.finalMatch = { 
                       team1: this.teams[0].name, 
                       team2: this.teams[1].name, 
                       sets: [ { s1: null, s2: null }, { s1: null, s2: null }, { s1: null, s2: null } ],
                       setsWon1: 0, setsWon2: 0, played: false, winner: null, mvp: ''
                    };
                   this.saveStateToFirestore();
                }
            }
            
            this.resetTournament = function() {
                this.showConfirm("¬øEst√°s seguro de que deseas reiniciar el torneo?", async () => {
                    if (!this.userId) return;
                    const mainStateRef = doc(this.db, "tournaments", this.appId, "data", "mainState");
                    await deleteDoc(mainStateRef);
                });
            }

            this.renderAll = function() {
                if (!this.isAuthenticated) return;
                
                this.calculateTeamStats();
                
                const scheduleGenerated = this.schedule.length > 0;
                document.getElementById('team-name').disabled = scheduleGenerated;
                document.getElementById('add-team-btn').disabled = scheduleGenerated;
                document.getElementById('add-team-wrapper').classList.toggle('opacity-50', scheduleGenerated);

                this.renderTeams();
                this.renderSchedule();
                this.renderStandings();
                
                this.checkIfTournamentFinished();
                
                if (this.finalMatch) {
                    if (this.finalMatch.winner) {
                        document.getElementById('winner-section').classList.remove('hidden');
                        document.getElementById('winner-name').textContent = `üéâ ${this.finalMatch.winner} üéâ`;
                        document.getElementById('main-content').classList.add('hidden');
                    } else {
                        document.getElementById('winner-section').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        this.renderFinalMatch();
                    }
                } else {
                     document.getElementById('main-content').classList.remove('hidden');
                     document.getElementById('winner-section').classList.add('hidden');
                     document.getElementById('final-match-section').classList.add('hidden');
                }
            }
            
            this.renderTeams = function() {
                const list = document.getElementById('teams-list');
                list.innerHTML = this.teams.map((team, index) => `
                    <div class="flex justify-between items-center bg-slate-100 p-2 rounded">
                        <span class="font-semibold">${team.name}</span>
                        <button onclick="app.removeTeam(${index})" class="text-red-500 hover:text-red-700 text-sm font-bold">X</button>
                    </div>`).join('');
                document.getElementById('clear-teams-btn').classList.toggle('hidden', this.teams.length === 0);
                const hasData = this.teams.length > 0 || this.schedule.length > 0;
                document.getElementById('reset-tournament-btn').classList.toggle('hidden', !hasData);
                document.getElementById('generate-schedule-btn').disabled = this.teams.length < 2 || this.schedule.length > 0;
            }
            
            this.renderMatchCard = function(match, index, isFinal = false) {
                 const idPrefix = isFinal ? 'final' : (index ?? 'final');
                 const readonlyAttr = match.played ? 'readonly' : '';
                 const onInputChange = `oninput="app.updateLiveScoreDisplay(${isFinal ? 'null' : index}, ${isFinal})"`;
                 
                 const showSet3 = (match.setsWon1 === 1 && match.setsWon2 === 1) || (match.sets[2] && (match.sets[2].s1 !== null || match.sets[2].s2 !== null));

                 return `
                    <div class="border p-4 rounded-lg ${match.played ? 'bg-slate-50' : ''}">
                        <div class="flex items-center justify-around gap-4 mb-4">
                            <div class="w-2/5 text-center font-bold text-lg">${match.team1}</div>
                            <div id="main-score-${idPrefix}" class="text-3xl font-bold text-blue-700">${match.setsWon1} - ${match.setsWon2}</div>
                            <div class="w-2/5 text-center font-bold text-lg">${match.team2}</div>
                        </div>

                        <div class="space-y-2">
                            <div class="grid grid-cols-3 gap-x-4 items-center text-center">
                                <div class="font-semibold text-slate-500">Set 1</div>
                                <div class="flex items-center gap-2">
                                    <input type="number" min="0" id="set1-s1-${idPrefix}" class="input-field text-center" value="${match.sets[0].s1 ?? ''}" ${readonlyAttr} ${onInputChange}>
                                    <span>-</span>
                                    <input type="number" min="0" id="set1-s2-${idPrefix}" class="input-field text-center" value="${match.sets[0].s2 ?? ''}" ${readonlyAttr} ${onInputChange}>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-x-4 items-center text-center">
                                <div class="font-semibold text-slate-500">Set 2</div>
                                <div class="flex items-center gap-2">
                                    <input type="number" min="0" id="set2-s1-${idPrefix}" class="input-field text-center" value="${match.sets[1].s1 ?? ''}" ${readonlyAttr} ${onInputChange}>
                                    <span>-</span>
                                    <input type="number" min="0" id="set2-s2-${idPrefix}" class="input-field text-center" value="${match.sets[1].s2 ?? ''}" ${readonlyAttr} ${onInputChange}>
                                </div>
                            </div>
                            <div id="set3-wrapper-${idPrefix}" class="grid grid-cols-3 gap-x-4 items-center text-center ${showSet3 ? '' : 'hidden'}">
                                <div class="font-semibold text-slate-500">Set 3</div>
                                <div class="flex items-center gap-2">
                                    <input type="number" min="0" id="set3-s1-${idPrefix}" class="input-field text-center" value="${match.sets[2].s1 ?? ''}" ${readonlyAttr} ${onInputChange}>
                                    <span>-</span>
                                    <input type="number" min="0" id="set3-s2-${idPrefix}" class="input-field text-center" value="${match.sets[2].s2 ?? ''}" ${readonlyAttr} ${onInputChange}>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2">
                            <label for="mvp-${idPrefix}" class="text-sm font-semibold whitespace-nowrap">üèÖ Jugador Destacado:</label>
                            <input type="text" id="mvp-${idPrefix}" class="input-field ${readonlyAttr ? 'bg-slate-100 cursor-not-allowed' : ''}" placeholder="Nombre" value="${match.mvp || ''}" ${readonlyAttr}>
                        </div>
                        
                        <div class="mt-4 flex justify-center">
                             <button onclick="app.updateMatchScores(${isFinal ? 'null' : index}, ${isFinal})" class="btn btn-primary btn-sm ${match.played ? 'hidden' : ''}">Guardar Marcador</button>
                        </div>
                    </div>
                `;
            }

            this.renderSchedule = function() {
                const section = document.getElementById('schedule-section');
                section.classList.toggle('hidden', this.schedule.length === 0);
                const list = document.getElementById('schedule-list');

                if (this.schedule.length === 0) {
                    list.innerHTML = '';
                    return;
                }

                let html = this.schedule.map((match, index) => {
                    return `<div class="mb-8">
                                <h3 class="text-xl font-semibold mb-4 text-center text-slate-700 border-b pb-2">Jornada ${match.round}</h3>
                                <div class="space-y-6 mt-4">
                                    ${this.renderMatchCard(match, index, false)}
                                </div>
                           </div>`;
                }).join('');
                
                list.innerHTML = html;
            }

            
            this.renderFinalMatch = function() {
                document.getElementById('final-match-section').classList.remove('hidden');
                document.getElementById('final-match-container').innerHTML = this.renderMatchCard(this.finalMatch, null, true);
            }

            this.renderStandings = function() {
                const section = document.getElementById('standings-section');
                section.classList.toggle('hidden', this.teams.length === 0);
                const body = document.getElementById('standings-body');
                body.innerHTML = this.teams.map((team, index) => `
                    <tr class="${index < 2 ? 'bg-blue-100' : ''} hover:bg-slate-50">
                        <td class="p-2 font-bold">${index + 1}</td>
                        <td class="p-2">${team.name}</td>
                        <td class="p-2 text-center">${team.pj}</td>
                        <td class="p-2 text-center">${team.g}</td>
                        <td class="p-2 text-center">${team.p}</td>
                        <td class="p-2 text-center">${team.sf}</td>
                        <td class="p-2 text-center">${team.sc}</td>
                        <td class="p-2 text-center font-semibold">${team.ds}</td>
                        <td class="p-2 text-center">${team.pf}</td>
                        <td class="p-2 text-center">${team.pc}</td>
                        <td class="p-2 text-center font-semibold">${team.dp}</td>
                        <td class="p-2 text-center font-bold text-blue-600">${team.pts}</td>
                    </tr>`).join('');
            }
        }
        
        const app = new App();
        document.addEventListener('DOMContentLoaded', () => app.init());
        window.app = app; 

    </script>
</body>
</html>

